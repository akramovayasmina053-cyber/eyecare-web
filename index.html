<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeCare+ Pro Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: sans-serif; margin: 0; text-align: center; background: #f4f7f6; }
        #camera-container { position: relative; width: 100%; height: 180px; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        #distance-info { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; color: white; font-weight: bold; }
        .test-area { padding: 20px; min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #display-element { font-size: 60px; margin-bottom: 30px; transition: all 0.3s; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-width: 400px; }
        .opt-btn { padding: 15px; font-size: 18px; border: none; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .opt-btn:active { background: #e0e0e0; }
        .overlay { position: fixed; top: 180px; left: 0; right: 0; bottom: 0; background: rgba(244,247,246,0.95); display: flex; justify-content: center; align-items: center; z-index: 100; text-align: center; padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="webcam" autoplay playsinline></video>
        <div id="distance-info">Masofa: -- sm</div>
    </div>

    <div id="dist-warn" class="overlay">
        <h2>Masofani sozlang!</h2>
        <p>Iltimos, telefonni yuzingizdan <b>90-100 sm</b> uzoqlikda tuting.<br>Hozirgi masofa: <span id="cur-dist">0</span> sm</p>
    </div>

    <div class="test-area">
        <div id="display-element">...</div>
        <div class="options-grid" id="options"></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const videoElement = document.getElementById('webcam');
    const distanceInfo = document.getElementById('distance-info');
    const distWarn = document.getElementById('dist-warn');
    const displayElement = document.getElementById('display-element');
    const optionsGrid = document.getElementById('options');
    
    const urlParams = new URLSearchParams(window.location.search);
    const age = parseInt(urlParams.get('age')) || 20;

    let currentStep = 0;
    let correctAnswers = 0;
    let isDistanceOk = false;
    let testType = age < 9 ? 'kids' : (age < 15 ? 'teens' : 'adults');

    const datasets = {
        kids: ['ðŸ¶', 'ðŸ±', 'ðŸŽ', 'ðŸ ', 'ðŸš—', 'â˜€ï¸', 'ðŸŽˆ', 'ðŸŒ', 'ðŸ˜'],
        teens: ['Ð¨', 'Ð‘', 'Ðœ', 'Ð', 'Ðš', 'Ð«', 'Ð˜', 'ÐŸ', 'Ð›'],
        adults: ['1', '5', '8', '3', '2', '9', '0', '6', '4'],
        colors: [
            {n: 'Qizil', c: '#ff0000'}, {n: 'Yashil', c: '#00ff00'}, 
            {n: 'Ko\'k', c: '#0000ff'}, {n: 'Sariq', c: '#ffff00'}
        ]
    };

    function generateOptions(correct) {
        let options = [correct];
        let pool = currentStep < 9 ? datasets[testType] : datasets.colors.map(i => i.n);
        while(options.length < 4) {
            let rand = pool[Math.floor(Math.random() * pool.length)];
            if(!options.includes(rand)) options.push(rand);
        }
        return options.sort(() => Math.random() - 0.5);
    }

    function nextQuestion() {
        if (currentStep >= 13) return finishTest();
        
        optionsGrid.innerHTML = '';
        let size = 60 - (currentStep * 5); // Har safar kichrayadi
        displayElement.style.fontSize = size + 'px';

        if (currentStep < 9) {
            let symbol = datasets[testType][currentStep];
            displayElement.innerText = symbol;
            displayElement.style.color = 'black';
            generateOptions(symbol).forEach(opt => createBtn(opt, symbol));
        } else {
            let colorObj = datasets.colors[currentStep - 9];
            displayElement.innerText = 'â— RANGNI TANLANG';
            displayElement.style.color = colorObj.c;
            generateOptions(colorObj.n).forEach(opt => createBtn(opt, colorObj.n));
        }
    }

    function createBtn(text, correct) {
        const btn = document.createElement('button');
        btn.className = 'opt-btn';
        btn.innerText = text;
        btn.onclick = () => {
            if(text === correct) correctAnswers++;
            currentStep++;
            nextQuestion();
        };
        optionsGrid.appendChild(btn);
    }

    function finishTest() {
        let score = (correctAnswers / 13) * 100;
        let diagnosis = "";
        if(score > 80) diagnosis = "Sizning ko'rishingiz a'lo darajada!";
        else if(score > 50) diagnosis = "Sizda ko'z zo'riqishi alomatlari bor. 20-20-20 qoidasiga amal qiling va 'Sisteyn' tomchilaridan foydalanishni maslahat beramiz.";
        else diagnosis = "Sizda boshlang'ich miopiya bo'lishi mumkin. Oftalmolog ko'rigidan o'ting. 'Taufon' tomchilari charchoqni oladi.";
        
        tg.sendData(`Natija: ${score.toFixed(0)}% | Tashxis: ${diagnosis}`);
        tg.close();
    }

    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
    faceMesh.onResults(results => {
        if (results.multiFaceLandmarks.length > 0) {
            const points = results.multiFaceLandmarks[0];
            const p1 = points[33], p2 = points[263];
            const dist = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            const realDist = Math.round(15 / dist); // 90-100 sm uchun kalibrlash
            
            document.getElementById('cur-dist').innerText = realDist;
            distanceInfo.innerText = `Masofa: ${realDist} sm`;

            if (realDist >= 90 && realDist <= 110) {
                isDistanceOk = true;
                distWarn.classList.add('hidden');
                distanceInfo.style.background = 'green';
            } else {
                isDistanceOk = false;
                distWarn.classList.remove('hidden');
                distanceInfo.style.background = 'red';
            }
        }
    });

    async function start() {
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        videoElement.srcObject = stream;
        const camera = new Camera(videoElement, {onFrame: async () => { await faceMesh.send({image: videoElement}); }, width: 640, height: 480});
        camera.start();
        nextQuestion();
    }
    start();
</script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
</body>
</html>
