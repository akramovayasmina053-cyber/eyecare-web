<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeCare+ Vision Test (1m)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; background: #fff; height: 100vh; overflow: hidden; }
        #camera-container { position: relative; width: 100%; height: 18vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #distance-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #fff; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; z-index: 10; }
        #test-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; position: relative; }
        #display-element { font-weight: bold; transition: all 0.3s; text-align: center; margin-bottom: 25px; }
        .options-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 90%; }
        .btn { background: #007bff; color: white; border: none; padding: 15px; border-radius: 10px; font-size: 18px; cursor: pointer; }
        #warning-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; align-items: center; justify-content: center; z-index: 50; text-align: center; visibility: visible; }
        #result-screen { display: none; padding: 20px; background: white; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; overflow-y: auto; }
        .card { background: #f8f9fa; border-left: 5px solid #007bff; padding: 15px; margin-bottom: 10px; border-radius: 5px; line-height: 1.6; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="webcam" autoplay playsinline></video>
    <div id="distance-badge">Tayyorlanmoqda...</div>
</div>

<div id="test-area">
    <div id="warning-overlay">
        <div>
            <h2 style="color:#dc3545">Masofani saqlang!</h2>
            <p>Iltimos, telefondan <b>90-100 sm</b> (1 metr) uzoqlikda turing.</p>
            <p id="live-dist" style="font-weight:bold; font-size:20px;"></p>
        </div>
    </div>
    <div id="step-info" style="font-size: 14px; color: #666; margin-bottom: 10px;"></div>
    <div id="display-element"></div>
    <div class="options-container" id="options"></div>
</div>

<div id="result-screen">
    <h2 style="text-align: center; color: #007bff;">Test Yakunlandi</h2>
    <div id="final-diagnosis"></div>
    <button class="btn" style="width:100%" onclick="tg.close()">Botga qaytish</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const age = new URLSearchParams(window.location.search).get('age') || 20;

    const assets = {
        kids: ['üê∂', 'üê±', 'ü¶Å', 'üçé', 'üè†', 'üöó', '‚≠ê', 'üéà', 'üêù', 'üç¶'],
        letters: ['–®', '–ë', '–ú', '–ù', '–ö', '–´', '–ò', '–ü', '–õ', '–£'],
        numbers: ['1', '5', '8', '0', '3', '6', '9', '4', '7', '2'],
        colors: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF']
    };

    let currentTest = (age <= 8) ? 'kids' : 'letters';
    let step = 0;
    let errors = { near: 0, far: 0, color: 0 };
    let targetValue = '';
    let colorTested = false;

    function renderStep() {
        const display = document.getElementById('display-element');
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';

        let pool = assets[currentTest];
        let sizes = [110, 95, 80, 65, 50, 40, 30, 20, 12]; // 1m masofa uchun kichrayish
        let currentSize = sizes[step];

        targetValue = pool[Math.floor(Math.random() * pool.length)];
        display.style.fontSize = (currentTest === 'color_test') ? "100px" : currentSize + "px";
        display.innerText = (currentTest === 'color_test') ? "‚óè" : targetValue;
        display.style.color = (currentTest === 'color_test') ? targetValue : "#000";
        document.getElementById('step-info').innerText = `${currentTest} testi: ${step + 1}/9`;

        let opts = [targetValue];
        while(opts.length < 4) {
            let r = pool[Math.floor(Math.random() * pool.length)];
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'btn';
            if(currentTest === 'color_test') b.style.backgroundColor = opt;
            else b.innerText = opt;
            b.onclick = () => {
                if(opt !== targetValue) {
                    if(currentTest === 'color_test') errors.color++;
                    else (step < 4) ? errors.near++ : errors.far++;
                }
                nextStep();
            };
            optionsDiv.appendChild(b);
        });
    }

    function nextStep() {
        step++;
        if(step >= 9 || (currentTest === 'color_test' && step >= 6)) {
            if(currentTest === 'letters' && age > 8) { currentTest = 'numbers'; step = 0; renderStep(); }
            else if(currentTest !== 'color_test') askColor();
            else showResults();
        } else renderStep();
    }

    function askColor() {
        document.getElementById('display-element').style.display = 'none';
        document.getElementById('options').innerHTML = `<p style="grid-column:span 2">Daltonizm testini ishlaysizmi?</p>
        <button class="btn" onclick="colorTested=true; currentTest='color_test'; step=0; document.getElementById('display-element').style.display='block'; renderStep();">Ha</button>
        <button class="btn" style="background:#666" onclick="showResults()">Yo'q</button>`;
    }

    function showResults() {
        document.getElementById('test-area').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        
        let diag = "‚úÖ Ko'rish qobiliyati normal.";
        let dori = "";
        if (errors.near >= 2) {
            diag = "üîç **Tashxis:** Yaqinni ko'rolmaslik (Gipermetropiya).";
            dori = "üíß **Dori:** Sisteyn tomchisi (kunda 2 mahal 1 tomchidan).";
        } else if (errors.far >= 3) {
            diag = "üîç **Tashxis:** Uzoqni ko'rolmaslik (Miopiya).";
            dori = "üíä **Dori:** Viziomax vitamini (kunda 1 mahal 1 tabletka).";
        }

        let dalResult = colorTested ? (errors.color >= 3 ? "‚ö†Ô∏è Daltonizm ehtimoli! Shifokor ko'rigi shart." : "‚úÖ Rang ajratish normal.") : "‚ö™ Rang testi o'tkazilmadi.";

        document.getElementById('final-diagnosis').innerHTML = `
            <div class="card"><b>Asosiy xulosa:</b><br>${diag}<br>${dori}</div>
            <div class="card"><b>Rang testi:</b><br>${dalResult}</div>
            <div class="card"><b>Mashq:</b> 20-20-20 qoidasiga amal qiling.</div>`;
    }
async function setupAI() {
        const video = document.getElementById('webcam');
        
        // 1. Kameraga ruxsat so'rash va video oqimini ulash
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user" }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Kameraga ruxsat berilmadi! Iltimos, sozlamalardan ruxsat bering.");
            return;
        }

        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({ 
            maxNumFaces: 1, 
            refineLandmarks: false, 
            minDetectionConfidence: 0.5 
        });

        faceMesh.onResults(results => {
            const badge = document.getElementById('distance-badge');
            const warning = document.getElementById('warning-overlay');
            const liveDist = document.getElementById('live-dist');
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks[0]) {
                const p = results.multiFaceLandmarks[0];
                const d = Math.sqrt(Math.pow(p[33].x - p[263].x, 2) + Math.pow(p[33].y - p[263].y, 2));
                const cm = Math.round(18 / d); 
                
                badge.innerText = `Masofa: ~${cm} sm`;
                liveDist.innerText = `${cm} sm`;

                if (cm >= 90 && cm <= 110) {
                    badge.style.background = "#28a745";
                    warning.style.visibility = "hidden";
                } else {
                    // Masofa 90-110 oralig'ida bo'lmasa ogohlantirishni ko'rsatish
                    badge.style.background = "#dc3545";
                    warning.style.visibility = "visible";
                }
            }
        });

        const camera = new Camera(video, {
            onFrame: async () => { await faceMesh.send({image: video}); },
            width: 640, height: 480
        });
        camera.start();
    }
    async function setupAI() {
        const video = document.getElementById('webcam');
        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: false, minDetectionConfidence: 0.5 });

        faceMesh.onResults(results => {
            const badge = document.getElementById('distance-badge');
            const warning = document.getElementById('warning-overlay');
            const liveDist = document.getElementById('live-dist');
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks[0]) {
                const p = results.multiFaceLandmarks[0];
                const d = Math.sqrt(Math.pow(p[33].x - p[263].x, 2) + Math.pow(p[33].y - p[263].y, 2));
                const cm = Math.round(18 / d); // 1m masofaga moslangan formula
                
                badge.innerText = `Masofa: ~${cm} sm`;
                liveDist.innerText = `${cm} sm`;

                if (cm >= 90 && cm <= 110) {
                    badge.style.background = "#28a745";
                    warning.style.visibility = "hidden";
                }

