<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeCare+ Professional Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #0088cc; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
        #symbol-box { height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; border: 2px dashed #ddd; border-radius: 15px; }
        #symbol { font-weight: bold; color: #333; transition: 0.2s; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 18px; font-size: 18px; border: none; border-radius: 12px; background: var(--primary); color: white; cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.96); opacity: 0.9; }
        .info { font-size: 14px; color: #777; margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="card">
    <div class="info">Savol: <span id="q-num">1</span>/10</div>
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    <div id="symbol-box"><div id="symbol">...</div></div>
    <div class="grid" id="options"></div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const params = new URLSearchParams(window.location.search);
    const age = params.get('age') || '20';

    const testData = {
        "3": ["üçé", "üê∂", "üöó", "üè†", "üåü", "üê±", "üê•", "üå≥", "üéà", "üö≤"],
        "9": ["–®", "–ë", "–ú", "–ù", "–ö", "–´", "–ò", "–®", "–ë", "–ú"],
        "20": ["–ë", "–ö", "–®", "–ú", "–ò", "–ù", "–´", "–ö", "–®", "–ë"]
    };

    let step = 0;
    let errors = [];
    let questions = testData[age] || testData["20"];

    function update() {
        if (step >= 10) { finish(); return; }
        document.getElementById('q-num').innerText = step + 1;
        document.getElementById('progress').style.width = ((step + 1) * 10) + "%";
        let s = document.getElementById('symbol');
        s.innerText = questions[step];
        let baseSize = age === "3" ? 90 : 80;
        s.style.fontSize = (baseSize - (step * 7)) + "px";
        renderButtons();
    }

    function renderButtons() {
        const box = document.getElementById('options');
        box.innerHTML = "";
        let correct = questions[step];
        let others = ["O", "X", "P", "L", "K", "M"].filter(x => x !== correct).sort(() => 0.5 - Math.random()).slice(0, 3);
        let choices = [correct, ...others].sort(() => 0.5 - Math.random());
        choices.forEach(text => {
            const btn = document.createElement('button');
            btn.innerText = text;
            btn.onclick = () => { if (text !== correct) errors.push(step); step++; update(); };
            box.appendChild(btn);
        });
    }

    function finish() {
        let diag = "";
        let earlyErrors = errors.filter(x => x < 5).length;
        let lateErrors = errors.filter(x => x >= 5).length;

        if (earlyErrors >= 2) {
            diag = "üìç Tashxis: Gipermetropiya (Yaqinni ko'rishda zaiflik).\nüíä Tavsiya: 'Sisteyn' tomchisi.";
        } else if (lateErrors >= 2) {
            diag = "üìç Tashxis: Miopiya (Uzoqni ko'rishda zaiflik).\nüíä Tavsiya: 'Taufon' tomchisi.";
        } else {
            diag = "‚úÖ Natija: Ko'rish qobiliyati normal.\nüíä Tavsiya: Profilaktik mashqlar.";
        }

        tg.sendData(diag);
        tg.close();
    }
    update();
</script>
</body>
</html>
