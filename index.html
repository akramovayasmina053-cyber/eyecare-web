<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeCare+ Professional Diagnostic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; text-align: center; background: #f8fafc; color: #1e293b; overflow-x: hidden; }
        #camera-container { position: relative; width: 100%; height: 140px; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; }
        #distance-badge { position: absolute; top: 10px; right: 10px; padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 12px; z-index: 10; }
        .test-window { padding: 20px; height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #display-element { font-weight: bold; line-height: 1; transition: all 0.2s; margin-bottom: 30px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-width: 340px; }
        .opt-btn { padding: 18px; font-size: 20px; border: 2px solid #e2e8f0; background: white; border-radius: 15px; cursor: pointer; font-weight: bold; color: #334155; }
        .opt-btn:active { transform: scale(0.96); background: #f1f5f9; }
        .lock-overlay { position: fixed; top: 140px; left: 0; right: 0; bottom: 0; background: rgba(248,250,252,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .hidden { display: none !important; }
        #color-prompt { font-size: 18px; color: #64748b; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="webcam" autoplay playsinline></video>
        <div id="distance-badge" style="background: #ef4444;">Masofa: 0 sm</div>
    </div>

    <div id="lock" class="lock-overlay">
        <h2 style="color: #ef4444;">Masofani saqlang (90-100 sm)</h2>
        <p>Hozirgi masofa: <span id="cur-dist">0</span> sm</p>
        <p style="font-size: 14px; color: #64748b;">Telefonni yuzingizdan uzoqlashtiring</p>
    </div>

    <div class="test-window">
        <div id="color-prompt" class="hidden">Qaysi rangni ko'ryapsiz?</div>
        <div id="display-element">...</div>
        <div class="options-grid" id="buttons"></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const videoEl = document.getElementById('webcam');
    const distBadge = document.getElementById('distance-badge');
    const lockScreen = document.getElementById('lock');
    const displayEl = document.getElementById('display-element');
    const btnGrid = document.getElementById('buttons');
    
    const params = new URLSearchParams(window.location.search);
    const age = parseInt(params.get('age')) || 20;

    let step = 0;
    let mainResults = []; // {step, correct}
    let colorResults = [];
    let testType = age < 9 ? 'kids' : (age < 15 ? 'teens' : 'adults');
    let isColorPhase = false;

    // O'xshash belgilar guruhlari (Chalg'itish uchun)
    const groups = {
        adults: '086 174 568 382 906 423 532'.split(' '),
        teens: '–®–©–ü –ë–ú–ù –ö–ù–ò –õ–ò–ê –û–°–ó –ï–Å–≠'.split(' '),
        kids: 'üê∂üê±üê≠ üçéüçíüçì üè†üè¢üè• üöóüöïüöå ‚òÄÔ∏è‚≠êüåô'.split(' ')
    };

    const visionScales = [0.5, 0.45, 0.4, 0.35, 0.3, 0.25, 0.2, 0.15, 0.12];

    function getVariants(target, poolType) {
        let variants = [target];
        let pool = [];
        if(poolType === 'colors') {
            pool = ['Qizil', 'Yashil', 'Ko\'k', 'Sariq', 'Olovrang', 'Siyohrang', 'Jigarrang'];
        } else {
            const match = groups[testType].find(g => g.includes(target));
            pool = match ? match.split('') : (testType === 'adults' ? '0123456789'.split('') : '–®–ë–ú–ù–ö–´–ò–ü'.split(''));
        }
        while(variants.length < 4) {
            let r = pool[Math.floor(Math.random() * pool.length)];
            if(!variants.includes(r)) variants.push(r);
        }
        return variants.sort(() => Math.random() - 0.5);
    }

    function startStep() {
        if(step >= 9 && !isColorPhase) {
            confirmColorTest();
            return;
        }
        if(step >= 14) return finish();

        btnGrid.innerHTML = '';
        if(!isColorPhase) {
            let scale = visionScales[step];
            displayEl.style.fontSize = (scale * 220) + "px"; // Kattalikni biroz kichraytirdik
            displayEl.style.color = "black";
            let chars = testType === 'adults' ? "0123456789" : (testType === 'teens' ? "–®–ë–ú–ù–ö–´–ò–ü" : "üê∂üçéüè†‚òÄÔ∏èüöó");
            let target = chars[Math.floor(Math.random() * chars.length)];
            displayEl.innerText = target;
            getVariants(target, 'main').forEach(v => createBtn(v, target));
        } else {
            document.getElementById('color-prompt').classList.remove('hidden');
            displayEl.style.fontSize = "70px";
            displayEl.innerText = "‚óè";
            const colors = [
                {n:'Qizil', c:'#e11d48'}, {n:'Yashil', c:'#16a34a'}, 
                {n:'Ko\'k', c:'#2563eb'}, {n:'Sariq', c:'#ca8a04'}, {n:'Siyohrang', c:'#9333ea'}
            ];
            let target = colors[Math.floor(Math.random() * colors.length)];
            displayEl.style.color = target.c;
            getVariants(target.n, 'colors').forEach(v => createBtn(v, target.n));
        }
    }

    function createBtn(txt, correct) {
        const b = document.createElement('button');
        b.className = 'opt-btn';
        b.innerText = txt;
        b.onclick = () => {
            let isCorrect = (txt === correct);
            if(!isColorPhase) mainResults.push(isCorrect);
            else colorResults.push(isCorrect);
            step++;
            startStep();
        };
        btnGrid.appendChild(b);
    }

    function confirmColorTest() {
        displayEl.style.fontSize = "20px";
        displayEl.innerText = "Asosiy test tugadi. Rang ajratish testini ham topshirasizmi?";
        btnGrid.innerHTML = '';
        const y = document.createElement('button');
        y.className = 'opt-btn'; y.innerText = "Ha, davom etish";
        y.onclick = () => { isColorPhase = true; startStep(); };
        const n = document.createElement('button');
        n.className = 'opt-btn'; n.innerText = "Yo'q, natijani ko'rish";
        n.onclick = () => finish();
        btnGrid.appendChild(y); btnGrid.appendChild(n);
    }

    function finish() {
        let first4 = mainResults.slice(0, 4).filter(r => !r).length;
        let last4 = mainResults.slice(5, 9).filter(r => !r).length;
        let colorErrors = colorResults.filter(r => !r).length;

        let diagnosis = "üìã **Tashxis natijalari:**\n\n";

        // Asosiy test tahlili
        if(first4 >= 2) diagnosis += "üìç **Yaqinni ko'ra olmaslik (Gipermetropiya):** Boshlang'ich alomatlar sezildi. Yaqin masofadagi narsalarda ko'z tez charchaydi.\n";
        else if(last4 >= 2) diagnosis += "üìç **Uzoqni ko'ra olmaslik (Miopiya):** Uzoqdagi belgilarni ajratishda qiynalyapsiz. Bu ko'zning optik o'qi uzayganidan bo'lishi mumkin.\n";
        else diagnosis += "‚úÖ **Asosiy ko'rish:** Normal holatda.\n";

        // Rang testi tahlili
        if(isColorPhase) {
            if(colorErrors >= 3) diagnosis += "üìç **Rang ajratish:** Sizda Daltonizm alomatlari bo'lishi mumkin. Shifokor ko'rigi zarur!\n";
            else if(colorErrors >= 1) diagnosis += "üìç **Rang ajratish:** Ranglarni farqlashda biroz susayish bor.\n";
            else diagnosis += "‚úÖ **Rang ajratish:** A'lo.\n";
        } else {
            diagnosis += "üìç **Rang ajratish:** Test topshirilmadi.\n";
        }

        diagnosis += "\nüíä **Tavsiya etiladigan dorilar:**\n" +
                     "‚Ä¢ **Sisteyn Ultra:** Kuniga 3 mahal, 1 tomchidan (Ko'z qurishi uchun).\n" +
                     "‚Ä¢ **Taufon:** Kuniga 2 mahal, 1 tomchidan (Ko'zni oziqlantirish uchun).\n\n" +
                     "üëÄ **Mashq:** Har 20 daqiqada 20 metr uzoqlikka 20 soniya qarang.";

        tg.sendData(diagnosis);
        tg.close();
    }

    // Kamera/Masofa logic (90-100 sm)
    const faceMesh = new FaceMesh({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
    faceMesh.onResults(res => {
        if (res.multiFaceLandmarks.length > 0) {
            const p = res.multiFaceLandmarks[0];
            const d = Math.sqrt(Math.pow(p[33].x - p[263].x, 2) + Math.pow(p[33].y - p[263].y, 2));
            const realCm = Math.round(15.5 / d); 
            
            document.getElementById('cur-dist').innerText = realCm;
            distBadge.innerText = `Masofa: ${realCm} sm`;

            if (realCm >= 85 && realCm <= 105) {
                lockScreen.classList.add('hidden');
                distBadge.style.background = '#22c55e';
            } else {
                lockScreen.classList.remove('hidden');
                distBadge.style.background = '#ef4444';
            }
        }
    });

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        videoEl.srcObject = stream;
        const cam = new Camera(videoEl, {onFrame: async () => { await faceMesh.send({image: videoEl}); }, width: 640, height: 480});
        cam.start();
        startStep();
    }
    init();
</script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
</body>
</html>
