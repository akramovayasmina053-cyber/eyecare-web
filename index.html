<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeCare+ Vision Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f9; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        #camera-container { width: 100%; height: 20vh; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        #distance-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 10; }
        #test-area { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
        #display-element { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin-bottom: 30px; user-select: none; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; max-width: 400px; }
        .btn { border: none; padding: 18px; border-radius: 15px; font-size: 20px; cursor: pointer; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn:active { transform: translateY(2px); }
        .btn-primary { background: var(--primary); color: white; }
        #warning-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.97); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        #step-info { position: absolute; top: 10px; left: 20px; color: #666; font-weight: 500; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="camera-container">
    <video id="webcam" autoplay playsinline></video>
    <div id="distance-badge">Masofa o'lchanmoqda...</div>
</div>

<div id="test-area">
    <div id="step-info">Tayyorlaning...</div>
    
    <div id="warning-overlay">
        <h2 id="status-title" style="color: var(--danger)">Kamera ruxsati kerak</h2>
        <p id="status-desc">Testni boshlash uchun kameraga ruxsat bering va 1 metr masofani saqlang.</p>
        <p id="live-dist" style="font-size: 30px; font-weight: bold; color: var(--primary)">-- sm</p>
        <button class="btn btn-primary" id="start-btn" onclick="startExperience()">Kamerani yoqish</button>
    </div>

    <div id="display-element" class="hidden"></div>
    <div id="options" class="options-grid"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const age = new URLSearchParams(window.location.search).get('age') || 20;
    const assets = {
        kids: ['üê∂', 'üê±', 'ü¶Å', 'üçé', 'üè†', 'üöó', '‚≠ê', 'üéà', 'üêù', 'üç¶'],
        letters: ['–®', '–ë', '–ú', '–ù', '–ö', '–´', '–ò', '–ü', '–õ', '–£'],
        numbers: ['1', '5', '8', '0', '3', '6', '9', '4', '7', '2'],
        colors: ['#E63946', '#F1FAEE', '#A8DADC', '#457B9D', '#1D3557', '#FFB703', '#FB8500']
    };

    // Test parametrlari
    let testSequence = (age <= 8) ? ['kids'] : ['letters', 'numbers'];
    let currentModeIdx = 0;
    let step = 0;
    let history = [];
    let errors = { near: 0, far: 0, color: 0 };
    let colorTested = false;

    // Masofa nazorati (Mediapipe)
    async function startExperience() {
        document.getElementById('start-btn').innerText = "Yuklanmoqda...";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('webcam').srcObject = stream;
            setupAI();
            initTest();
        } catch (e) {
            alert("Kameraga ruxsat berilmadi!");
        }
    }

    function setupAI() {
        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
        faceMesh.onResults(results => {
            const badge = document.getElementById('distance-badge');
            const overlay = document.getElementById('warning-overlay');
            const liveDist = document.getElementById('live-dist');
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks[0]) {
                const p = results.multiFaceLandmarks[0];
                const d = Math.sqrt(Math.pow(p[33].x - p[263].x, 2) + Math.pow(p[33].y - p[263].y, 2));
                const cm = Math.round(18 / d); // 1 metr uchun kalibrlash
                
                badge.innerText = `Masofa: ~${cm} sm`;
                liveDist.innerText = `${cm} sm`;

                if (cm >= 90 && cm <= 110) {
                    overlay.classList.add('hidden');
                    document.getElementById('display-element').classList.remove('hidden');
                } else {
                    overlay.classList.remove('hidden');
                    document.getElementById('status-title').innerText = "Masofani to'g'rilang!";
                    document.getElementById('status-desc').innerText = "Iltimos, 90-110 sm masofada turing.";
                    document.getElementById('start-btn').classList.add('hidden');
                }
            }
        });

        const camera = new Camera(document.getElementById('webcam'), {
            onFrame: async () => { await faceMesh.send({image: document.getElementById('webcam')}); },
            width: 640, height: 480
        });
        camera.start();
    }

    function initTest() {
        step = 0;
        renderStep();
    }

    function renderStep() {
        const mode = testSequence[currentModeIdx];
        const display = document.getElementById('display-element');
        const optionsDiv = document.getElementById('options');
        const stepInfo = document.getElementById('step-info');
        
        optionsDiv.innerHTML = '';
        const pool = assets[mode];
        
        // Kattalik mantiqi: 0.3 dan 0.11 gacha kichrayish (Harf/Raqam/Shakl uchun)
        const sizeMap = [0.3, 0.27, 0.24, 0.21, 0.18, 0.16, 0.14, 0.12, 0.11];
        // Ranglar uchun: 0.4 dan 0.8 gacha (pixelga o'tkazilgan)
        const colorSizeMap = [140, 120, 100, 80, 60, 40];

        let target = pool[Math.floor(Math.random() * pool.length)];
        while(history.includes(target)) { target = pool[Math.floor(Math.random() * pool.length)]; }
        history.push(target);
        if(history.length > 5) history.shift();

        display.innerText = (mode === 'colors') ? "‚óè" : target;
        display.style.color = (mode === 'colors') ? target : "#000";
        
        let fs = (mode === 'colors') ? colorSizeMap[step] : sizeMap[step] * 500;
        display.style.fontSize = fs + "px";
        
        stepInfo.innerText = `${mode === 'kids' ? 'Bolalar testi' : (mode === 'colors' ? 'Rang testi' : 'Asosiy test')}: ${step + 1}/${mode === 'colors' ? 6 : 9}`;

        // Variantlarni yaratish
        let opts = [target];
        while(opts.length < 4) {
            let r = pool[Math.floor(Math.random() * pool.length)];
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'btn';
            if(mode === 'colors') b.style.backgroundColor = opt;
            else b.innerText = opt;
            b.onclick = () => handleAnswer(opt === target);
            optionsDiv.appendChild(b);
        });
    }

    function handleAnswer(isCorrect) {
        const mode = testSequence[currentModeIdx];
        if(!isCorrect) {
            if(mode === 'colors') errors.color++;
            else if(step < 4) errors.near++;
            else errors.far++;
        }

        step++;
        const maxSteps = (mode === 'colors') ? 6 : 9;

        if(step >= maxSteps) {
            currentModeIdx++;
            if(currentModeIdx < testSequence.length) {
                step = 0;
                renderStep();
            } else if(!colorTested) {
                askColorPreference();
            } else {
                finish();
            }
        } else {
            renderStep();
        }
    }

    function askColorPreference() {
        colorTested = true;
        document.getElementById('display-element').classList.add('hidden');
        document.getElementById('step-info').innerText = "Yakuniy bosqich";
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = `
            <p style="grid-column: span 2; text-align:center">Daltonizm (rang ajratish) testini topshirasizmi?</p>
            <button class="btn btn-primary" onclick="startColorTest()">Ha, xohlayman</button>
            <button class="btn" onclick="finish()">Yo'q, xohlamayman</button>
        `;
    }

    function startColorTest() {
        testSequence = ['colors'];
        currentModeIdx = 0;
        step = 0;
        renderStep();
    }

    function finish() {
        let diagnosis = "‚úÖ Ko'rish qobiliyati normal.";
        let recommendation = "Koz nuringiz yaxshi. Profilaktika uchun ko'z mashqlarini bajaring.";
        let meds = "Tavsiya: Retsepsiz dori shart emas.";

        if (errors.near >= 2) {
            diagnosis = "üîç Yaqinni ko'rolmaslik (Gipermetropiya) alomatlari.";
            meds = "üíß Sisteyn Ultra (tomchi): kunda 2 mahal 1 tomchidan (ko'z toliqishini oladi).";
        } else if (errors.far >= 3) {
            diagnosis = "üîç Uzoqni ko'rolmaslik (Miopiya) alomatlari.";
            meds = "üíä Viziomaks vitamini: kunda 1 mahal 1 tabletkadan (30 kun).";
        }

        let daltonizm = "‚ö™ Rang testi ishlanmadi.";
        if(colorTested && testSequence[0] === 'colors') {
            if(errors.color >= 3) daltonizm = "‚ö†Ô∏è Sizda Daltonizm kasalligi bo'lishi mumkin. Iltimos, shifokorga murojaat qiling!";
            else if(errors.color >= 2) daltonizm = "üü° Rang ajratishda nuqsonlar boshlanmoqda. E'tiborli bo'ling.";
            else daltonizm = "‚úÖ Rang ajratish qobiliyati normal.";
        }

        const resultData = {
            diag: diagnosis,
            meds: meds,
            color_res: daltonizm,
            near_err: errors.near,
            far_err: errors.far,
            exercise: "Mashq: '20-20-20' qoidasi ‚Äî Har 20 daqiqada 20 metr uzoqlikka 20 soniya davomida qarang."
        };

        tg.sendData(JSON.stringify(resultData));
        tg.close();
    }
</script>
</body>
</html>
