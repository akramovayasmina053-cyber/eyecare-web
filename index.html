<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeCare+ Professional Diagnostic</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; background: #f0f4f8; margin: 0; padding: 15px; }
        .test-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        #video-container { position: relative; width: 100%; height: 180px; background: #000; border-radius: 15px; margin-bottom: 20px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #target-area { font-size: 70px; font-weight: bold; margin: 30px 0; min-height: 100px; display: flex; align-items: center; justify-content: center; }
        .color-circle { width: 120px; height: 120px; border-radius: 50%; margin: auto; border: 5px solid #eee; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 18px; font-size: 18px; border: none; border-radius: 12px; background: #0088cc; color: white; cursor: pointer; }
        button:active { transform: scale(0.98); background: #006699; }
        .step-info { color: #666; font-size: 14px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="test-container">
    <div class="step-info">Diagnostika: <span id="step-count">1</span> / 12</div>
    
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
        <div style="position:absolute; bottom:5px; width:100%; color:white; font-size:10px; background:rgba(0,0,0,0.5)">Kamera masofani nazorat qilish uchun</div>
    </div>

    <div id="target-area">...</div>

    <div class="options-grid" id="buttons-container"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const video = document.getElementById('webcam');
    const targetArea = document.getElementById('target-area');
    const btnContainer = document.getElementById('buttons-container');

    // Kamerani yoqish
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => { video.srcObject = stream; })
        .catch(err => console.log("Kamera ruxsati berilmadi"));

    const urlParams = new URLSearchParams(window.location.search);
    const age = urlParams.get('age') || '20';

    // Testlar bazasi (Raqam, Rang, Shakl)
    const tests = [
        { type: 'text', val: 'E', options: ['E', 'H', 'B', 'M'] },
        { type: 'text', val: '8', options: ['8', '3', '0', '6'] },
        { type: 'color', val: '#FF0000', label: 'Qizil', options: ['Qizil', 'Yashil', 'Ko\'k', 'Sariq'] },
        { type: 'text', val: '–®', options: ['–®', '–ò', '–ù', '–ö'] },
        { type: 'text', val: '5', options: ['5', '2', '6', '9'] },
        { type: 'color', val: '#00FF00', label: 'Yashil', options: ['Yashil', 'Jigarrang', 'Sariq', 'Qizil'] },
        { type: 'text', val: 'B', options: ['B', 'D', 'P', 'R'] },
        { type: 'text', val: '2', options: ['2', '7', 'Z', '5'] },
        { type: 'color', val: '#0000FF', label: 'Ko\'k', options: ['Ko\'k', 'Siyohrang', 'Yashil', 'Qizil'] },
        { type: 'text', val: 'M', options: ['M', 'W', 'N', 'H'] },
        { type: 'text', val: '0', options: ['0', 'O', '8', 'C'] },
        { type: 'text', val: 'K', options: ['K', 'X', 'Y', 'H'] }
    ];

    let currentStep = 0;
    let score = 0;

    function loadTest() {
        if (currentStep >= tests.length) {
            finishTest();
            return;
        }

        document.getElementById('step-count').innerText = currentStep + 1;
        const currentTest = tests[currentStep];
        targetArea.innerHTML = "";
        btnContainer.innerHTML = "";

        // Obyektni chiqarish
        if (currentTest.type === 'text') {
            targetArea.innerText = currentTest.val;
            targetArea.style.fontSize = (70 - (currentStep * 4)) + "px"; // Savol o'tgan sari kichrayadi
        } else if (currentTest.type === 'color') {
            const circle = document.createElement('div');
            circle.className = 'color-circle';
            circle.style.backgroundColor = currentTest.val;
            targetArea.appendChild(circle);
        }

        // Tugmalarni chiqarish
        currentTest.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            btnContainer.appendChild(btn);
        });
    }

    function checkAnswer(answer) {
        const current = tests[currentStep];
        const correctVal = current.type === 'color' ? current.label : current.val;
        
        if (answer === correctVal) score++;
        currentStep++;
        loadTest();
    }

    function finishTest() {
        let resultMsg = "";
        if (score >= 10) resultMsg = "‚úÖ Natija: Ko'rish qobiliyati a'lo. Daltonizm belgilari yo'q.";
        else if (score >= 7) resultMsg = "‚ö†Ô∏è Natija: Ko'rishda biroz zo'riqish bor. Profilaktika tavsiya etiladi.";
        else resultMsg = "üìç Natija: Ko'rish zaiflashgan. Mutaxassis ko'rigidan o'tishingiz shart.";

        tg.sendData(resultMsg);
        tg.close();
    }

    loadTest();
</script>
</body>
</html>
