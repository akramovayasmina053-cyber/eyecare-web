<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeCare+ Pro Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; text-align: center; background: #f0f2f5; color: #333; }
        #camera-container { position: relative; width: 100%; height: 160px; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; }
        #distance-badge { position: absolute; top: 10px; right: 10px; padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 14px; }
        .test-box { padding: 20px; height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #display-element { font-weight: bold; line-height: 1; transition: all 0.2s; margin-bottom: 40px; }
        .options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%; max-width: 350px; }
        .btn-opt { padding: 16px; font-size: 18px; border: 2px solid #ddd; background: white; border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .btn-opt:active { transform: scale(0.95); background: #f8f8f8; }
        .lock-screen { position: fixed; top: 160px; left: 0; right: 0; bottom: 0; background: rgba(240,242,245,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="webcam" autoplay playsinline></video>
        <div id="distance-badge" style="background: red;">Masofa: 0 sm</div>
    </div>

    <div id="distance-lock" class="lock-screen">
        <h2 style="color: #e74c3c;">Masofani to'g'rilang!</h2>
        <p>Iltimos, telefonni yuzingizdan <b>90-100 sm</b> uzoqlikda tuting.</p>
        <p>Hozirgi masofa: <span id="live-dist">0</span> sm</p>
    </div>

    <div class="test-box">
        <div id="display-element">...</div>
        <div class="options-container" id="options-grid"></div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const videoElement = document.getElementById('webcam');
    const distanceBadge = document.getElementById('distance-badge');
    const distanceLock = document.getElementById('distance-lock');
    const displayElement = document.getElementById('display-element');
    const optionsGrid = document.getElementById('options-grid');
    
    const urlParams = new URLSearchParams(window.location.search);
    const age = parseInt(urlParams.get('age')) || 20;

    let step = 0;
    let correctCount = 0;
    let testType = age < 9 ? 'kids' : (age < 15 ? 'teens' : 'adults');

    // O'xshash belgilar guruhlari (Chalg'itish uchun)
    const similarGroups = {
        adults: ['174', '568', '382', '906', '423', '086', '532'],
        teens: ['–®–©–ü', '–ë–ú–ù', '–ö–ù–ò', '–õ–ò–ê', '–û–°–ó', '–ï–Å–≠'],
        kids: ['üê∂üê±üê≠', 'üçéüçíüçì', 'üè†üè¢üè•', 'üöóüöïüöå', '‚òÄÔ∏è‚≠êüåô'],
        colors: ['Qizil', 'Yashil', 'Ko\'k', 'Sariq', 'Olovrang', 'Siyohrang']
    };

    const visionLevels = [0.5, 0.4, 0.35, 0.3, 0.25, 0.2, 0.18, 0.15, 0.12];

    function getOptions(correct, type) {
        let opts = [correct];
        let pool = [];
        
        if(type === 'colors') pool = similarGroups.colors;
        else {
            const group = Object.values(similarGroups[testType]).find(g => g.includes(correct[0] || correct));
            pool = group ? group.split('') : (testType === 'adults' ? '0123456789'.split('') : '–®–ë–ú–ù–ö–´–ò–ü'.split(''));
        }

        while(opts.length < 4) {
            let rand = pool[Math.floor(Math.random() * pool.length)];
            if(!opts.includes(rand)) opts.push(rand);
        }
        return opts.sort(() => Math.random() - 0.5);
    }

    function runTest() {
        if(step >= 12) return finish();

        optionsGrid.innerHTML = '';
        let isColorTest = step >= 9;

        if(!isColorTest) {
            let scale = visionLevels[step];
            displayElement.style.fontSize = (scale * 200) + "px";
            displayElement.style.color = "black";
            
            let charPool = testType === 'adults' ? "0123456789" : (testType === 'teens' ? "–®–ë–ú–ù–ö–´–ò–ü" : "üê∂üçéüè†‚òÄÔ∏èüéà");
            let target = charPool[Math.floor(Math.random() * charPool.length)];
            displayElement.innerText = target;

            getOptions(target, 'chars').forEach(o => createBtn(o, target));
        } else {
            displayElement.style.fontSize = "60px";
            displayElement.innerText = "‚óè";
            let colors = [
                {n:'Qizil', c:'#e74c3c'}, {n:'Yashil', c:'#2ecc71'}, 
                {n:'Ko\'k', c:'#3498db'}, {n:'Sariq', c:'#f1c40f'}
            ];
            let targetColor = colors[Math.floor(Math.random() * colors.length)];
            displayElement.style.color = targetColor.c;

            getOptions(targetColor.n, 'colors').forEach(o => createBtn(o, targetColor.n));
        }
    }

    function createBtn(txt, cor) {
        const b = document.createElement('button');
        b.className = 'btn-opt';
        b.innerText = txt;
        b.onclick = () => {
            if(txt === cor) correctCount++;
            step++;
            runTest();
        };
        optionsGrid.appendChild(b);
    }

    function finish() {
        let res = (correctCount / 12) * 1.0;
        let msg = "";
        if(res >= 0.9) msg = "Ko'rish o'tkirligi a'lo (1.0). Ko'zlaringiz sog'lom!";
        else if(res >= 0.6) msg = "Sizda ko'z zo'riqishi (Miopiya boshlanishi) bo'lishi mumkin. 'Sisteyn' tomchisi va 20-20-20 mashqi tavsiya etiladi.";
        else msg = "Diqqat! Ko'rish pasaygan. Oftalmolog ko'rigi zarur. 'Taufon' tomchisi va maxsus mashqlar qiling.";
        
        tg.sendData(`üìä Natija: ${res.toFixed(2)} | Tashxis: ${msg}`);
        tg.close();
    }

    // Kamera va Masofa (Mediapipe)
    const faceMesh = new FaceMesh({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
    faceMesh.onResults(res => {
        if (res.multiFaceLandmarks.length > 0) {
            const p = res.multiFaceLandmarks[0];
            const d = Math.sqrt(Math.pow(p[33].x - p[263].x, 2) + Math.pow(p[33].y - p[263].y, 2));
            const actualDist = Math.round(16 / d);
            
            document.getElementById('live-dist').innerText = actualDist;
            distanceBadge.innerText = `Masofa: ${actualDist} sm`;

            if (actualDist >= 90 && actualDist <= 105) {
                distanceLock.classList.add('hidden');
                distanceBadge.style.background = '#2ecc71';
            } else {
                distanceLock.classList.remove('hidden');
                distanceBadge.style.background = '#e74c3c';
            }
        }
    });

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        videoElement.srcObject = stream;
        const cam = new Camera(videoElement, {onFrame: async () => { await faceMesh.send({image: videoElement}); }, width: 640, height: 480});
        cam.start();
        runTest();
    }
    init();
</script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
</body>
</html>
