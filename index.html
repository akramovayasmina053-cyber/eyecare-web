<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EyeCare Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f7f6; margin: 0; padding: 20px; touch-action: manipulation; }
        .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        #eye-symbol { font-size: 80px; font-weight: bold; margin: 40px 0; color: #333; min-height: 100px; display: flex; align-items: center; justify-content: center; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 15px; font-size: 18px; border: none; border-radius: 10px; background: #007bff; color: white; cursor: pointer; }
        button:active { background: #0056b3; }
        .progress { margin-bottom: 20px; font-size: 14px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress">Savol: <span id="current-num">1</span> / 9</div>
    <div id="eye-symbol">...</div>
    <div class="options" id="options-container">
        </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const age = urlParams.get('age') || '20';

    // SAVOLLAR BAZASI
    const questionsData = {
        "3": ["üçé", "üê∂", "üöó", "üè†", "üåü", "üê±", "üê•", "üå≥", "üéà"],
        "9": ["–®", "–ë", "–ú", "–ù", "–ö", "–´", "–ò", "–®", "–ë"],
        "20": ["–ë", "–ö", "–®", "–ú", "–ò", "–ù", "–´", "–ö", "–®"]
    };

    // VARIANTLAR (Har bir yosh uchun to'g'ri variantlar chiqishi uchun)
    const variantsData = {
        "3": ["üçé", "üê∂", "üöó", "üè†", "üåü", "üê±", "üê•", "üå≥", "üéà"],
        "9": ["–®", "–ë", "–ú", "–ù", "–ö", "–´", "–ò", "–ü", "–õ"],
        "20": ["–ë", "–ö", "–®", "–ú", "–ò", "–ù", "–´", "–£", "–ó"]
    };

    let currentStep = 0;
    let mainResults = [];
    const ageGroup = questionsData[age] ? age : "20";
    const questions = questionsData[ageGroup];

    function loadQuestion() {
        if (currentStep >= questions.length) {
            finishTest();
            return;
        }

        document.getElementById('current-num').innerText = currentStep + 1;
        const symbolDiv = document.getElementById('eye-symbol');
        symbolDiv.innerText = questions[currentStep];
        
        // Yosh o'tgan sari harf o'lchamini kichiklashtirish (Miopiya/Gipermetropiya testi uchun)
        let fontSize = 80 - (currentStep * 7); 
        symbolDiv.style.fontSize = fontSize + "px";

        generateButtons();
    }

    function generateButtons() {
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        // To'g'ri javob va 3 ta tasodifiy noto'g'ri javob
        let correct = questions[currentStep];
        let pool = variantsData[ageGroup].filter(v => v !== correct);
        let shuffled = pool.sort(() => 0.5 - Math.random()).slice(0, 3);
        shuffled.push(correct);
        shuffled.sort(() => 0.5 - Math.random());

        shuffled.forEach(text => {
            const btn = document.createElement('button');
            btn.innerText = text;
            btn.onclick = () => handleAnswer(text === correct);
            container.appendChild(btn);
        });
    }

    function handleAnswer(isCorrect) {
        mainResults.push(isCorrect);
        currentStep++;
        loadQuestion();
    }

    function finishTest() {
        let firstHalfErrors = mainResults.slice(0, 4).filter(r => !r).length;
        let secondHalfErrors = mainResults.slice(5, 9).filter(r => !r).length;
        
        let diagnosis = "";
        let advice = "";

        if (firstHalfErrors >= 2) {
            diagnosis = "üìç Taxminiy Tashxis: Gipermetropiya (Yaqinni ko'ra olmaslik).";
            advice = "üíä Tavsiya: 'Sisteyn Ultra' tomchisi. Yaqindan ko'p o'qimang.";
        } else if (secondHalfErrors >= 2) {
            diagnosis = "üìç Taxminiy Tashxis: Miopiya (Uzoqni ko'ra olmaslik).";
            advice = "üíä Tavsiya: 'Taufon' tomchisi. Har 20 daqiqada uzoqqa qarang.";
        } else {
            diagnosis = "‚úÖ Natija: Ko'rish qobiliyati normal.";
            advice = "üíä Tavsiya: Vitamin 'Lutein-Z' profilaktika uchun.";
        }

        const finalMsg = `${diagnosis}\n\n${advice}\n\nüßò Mashq: 20-20-20 qoidasiga amal qiling.`;
        
        tg.sendData(finalMsg);
        tg.close();
    }

    loadQuestion();
</script>

</body>
</html>
